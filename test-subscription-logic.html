<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Logic Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Subscription Logic Test</h1>
        
        <div class="test-section">
            <h2>üìã Test Requirements</h2>
            <ul>
                <li><strong>UniGuidePro:</strong> Should allow 3 free uses for free users</li>
                <li><strong>MyStudyAbroadPath:</strong> Should require paid subscription (0 free uses)</li>
                <li><strong>Free Plan Limits:</strong> uniGuideProUsage: 3, myStudyPathUsage: 0</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>üîß Test Functions</h2>
            <button onclick="testSubscriptionLimits()">Test Subscription Limits</button>
            <button onclick="testCanPerformAction()">Test Can Perform Action</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h2>üìä Test Results</h2>
            <div id="results"></div>
        </div>

        <div class="test-section">
            <h2>üìù Debug Log</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logElement = document.getElementById('log');
            logElement.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('results').innerHTML = '';
        }

        function addResult(test, passed, details) {
            const resultsElement = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result';
            resultDiv.innerHTML = `
                <span class="${passed ? 'pass' : 'fail'}">${passed ? '‚úÖ' : '‚ùå'}</span>
                <strong>${test}:</strong> ${details}
            `;
            resultsElement.appendChild(resultDiv);
        }

        function testSubscriptionLimits() {
            log('üß™ Testing Subscription Limits...');
            
            // Simulate free plan limits (what should be set)
            const expectedFreeLimits = {
                pathwaysPerMonth: 1,
                uniGuideProUsage: 3,     // Should allow 3 free uses
                myStudyPathUsage: 0,     // Should require paid plan
                universityComparisons: 3,
                pdfExports: 0,
                advancedFilters: false,
                analytics: false
            };

            // Simulate initial usage (new user)
            const initialUsage = {
                pathwaysGenerated: 0,
                uniGuideProUsage: 0,     // No uses yet
                myStudyPathUsage: 0,     // No uses yet
                universityComparisons: 0,
                pdfExports: 0
            };

            log('Expected Free Plan Limits: ' + JSON.stringify(expectedFreeLimits, null, 2));
            log('Initial Usage: ' + JSON.stringify(initialUsage, null, 2));

            // Test UniGuidePro permissions
            const canUseUniGuidePro = expectedFreeLimits.uniGuideProUsage === -1 || 
                                    initialUsage.uniGuideProUsage < expectedFreeLimits.uniGuideProUsage;
            
            addResult(
                'UniGuidePro Free Access', 
                canUseUniGuidePro, 
                `Should allow 3 free uses. Limit: ${expectedFreeLimits.uniGuideProUsage}, Used: ${initialUsage.uniGuideProUsage}, Can Use: ${canUseUniGuidePro}`
            );

            // Test MyStudyAbroadPath permissions
            const canUseMyStudyPath = expectedFreeLimits.myStudyPathUsage === -1 || 
                                    initialUsage.myStudyPathUsage < expectedFreeLimits.myStudyPathUsage;
            
            addResult(
                'MyStudyAbroadPath Paid Only', 
                !canUseMyStudyPath, 
                `Should require paid plan. Limit: ${expectedFreeLimits.myStudyPathUsage}, Used: ${initialUsage.myStudyPathUsage}, Can Use: ${canUseMyStudyPath}`
            );

            // Test after using UniGuidePro 3 times
            const usageAfter3Uses = { ...initialUsage, uniGuideProUsage: 3 };
            const canUseUniGuideProAfter3 = expectedFreeLimits.uniGuideProUsage === -1 || 
                                          usageAfter3.uniGuideProUsage < expectedFreeLimits.uniGuideProUsage;
            
            addResult(
                'UniGuidePro After 3 Uses', 
                !canUseUniGuideProAfter3, 
                `Should be blocked after 3 uses. Limit: ${expectedFreeLimits.uniGuideProUsage}, Used: ${usageAfter3.uniGuideProUsage}, Can Use: ${canUseUniGuideProAfter3}`
            );

            log('‚úÖ Subscription limits test completed');
        }

        function testCanPerformAction() {
            log('üß™ Testing canPerformAction Logic...');
            
            // Mock the canPerformAction function
            function mockCanPerformAction(action, limits, usage) {
                if (!limits || !usage) {
                    log(`‚ùå No limits or usage data for action: ${action}`);
                    return false;
                }

                switch (action) {
                    case 'useUniGuidePro':
                        const canUseUniGuidePro = limits.uniGuideProUsage === -1 || usage.uniGuideProUsage < limits.uniGuideProUsage;
                        log(`üéì useUniGuidePro: limit=${limits.uniGuideProUsage}, used=${usage.uniGuideProUsage}, can=${canUseUniGuidePro}`);
                        return canUseUniGuidePro;
                    
                    case 'useMyStudyPath':
                        const canUseMyStudyPath = limits.myStudyPathUsage === -1 || usage.myStudyPathUsage < limits.myStudyPathUsage;
                        log(`üìö useMyStudyPath: limit=${limits.myStudyPathUsage}, used=${usage.myStudyPathUsage}, can=${canUseMyStudyPath}`);
                        return canUseMyStudyPath;
                    
                    default:
                        log(`‚ùì Unknown action: ${action}`);
                        return false;
                }
            }

            const freeLimits = {
                uniGuideProUsage: 3,
                myStudyPathUsage: 0
            };

            // Test scenarios
            const scenarios = [
                { usage: { uniGuideProUsage: 0, myStudyPathUsage: 0 }, desc: 'New user' },
                { usage: { uniGuideProUsage: 1, myStudyPathUsage: 0 }, desc: 'After 1 UniGuidePro use' },
                { usage: { uniGuideProUsage: 2, myStudyPathUsage: 0 }, desc: 'After 2 UniGuidePro uses' },
                { usage: { uniGuideProUsage: 3, myStudyPathUsage: 0 }, desc: 'After 3 UniGuidePro uses' },
            ];

            scenarios.forEach(scenario => {
                log(`\n--- Testing: ${scenario.desc} ---`);
                
                const canUseUniGuidePro = mockCanPerformAction('useUniGuidePro', freeLimits, scenario.usage);
                const canUseMyStudyPath = mockCanPerformAction('useMyStudyPath', freeLimits, scenario.usage);
                
                // UniGuidePro should be available for first 3 uses
                const shouldAllowUniGuidePro = scenario.usage.uniGuideProUsage < 3;
                const uniGuideProCorrect = canUseUniGuidePro === shouldAllowUniGuidePro;
                
                // MyStudyAbroadPath should never be available for free users
                const myStudyPathCorrect = !canUseMyStudyPath;
                
                addResult(
                    `${scenario.desc} - UniGuidePro`,
                    uniGuideProCorrect,
                    `Expected: ${shouldAllowUniGuidePro}, Got: ${canUseUniGuidePro}`
                );
                
                addResult(
                    `${scenario.desc} - MyStudyPath`,
                    myStudyPathCorrect,
                    `Expected: false, Got: ${canUseMyStudyPath}`
                );
            });

            log('‚úÖ canPerformAction test completed');
        }

        // Auto-run tests on page load
        window.onload = function() {
            log('üöÄ Page loaded, running initial tests...');
            testSubscriptionLimits();
            testCanPerformAction();
        };
    </script>
</body>
</html>
